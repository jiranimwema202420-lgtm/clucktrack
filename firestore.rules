/**
 * This ruleset enforces a strict user-ownership security model for the CluckHub application.
 *
 * Core Philosophy:
 * The security model is centered around the principle that users own and control their own data.
 * All application data is private to the user who created it, and no data is publicly accessible.
 * This ensures strong data isolation and privacy for each user of the system.
 *
 * Data Structure:
 * All data is organized hierarchically under the `/users/{userId}` path. This structure naturally
 * segments data by owner, allowing for clear, efficient, and secure path-based authorization rules.
 * For example, a user's flocks are stored at `/users/{userId}/flocks/{flockId}`.
 *
 * Key Security Decisions:
 * - Strict Ownership: All read and write operations are restricted to the authenticated user
 *   whose UID matches the `{userId}` in the document path.
 * - No Public Access: There are no publicly readable collections. A user must be signed in
 *   and be the designated owner to access any document.
 * - User Listing Disabled: The rules explicitly prevent any client from listing the documents
 *   in the root `/users` collection, protecting user privacy.
 * - Self-Creation of User Profile: A user can create their own user profile document, but only
 *   if the document ID matches their authentication UID, ensuring data integrity.
 * - Data Validation: Writes are validated against a schema to ensure data integrity.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to improve readability and maintainability of the rules.
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingDocument() {
      return resource != null;
    }

    // Schema Validation Functions
    function isValidFlock(flockData) {
      return flockData.breed is string && flockData.breed.size() > 0
          && flockData.hatchDate is timestamp
          && flockData.count is number && flockData.count >= 0
          && flockData.initialCount is number && flockData.initialCount > 0
          && flockData.count <= flockData.initialCount
          && flockData.averageWeight is number && flockData.averageWeight >= 0
          && flockData.totalFeedConsumed is number && flockData.totalFeedConsumed >= 0
          && flockData.totalCost is number && flockData.totalCost >= 0;
    }

    function isValidSale(saleData) {
      return saleData.flockId is string && saleData.flockId.size() > 0
          && saleData.quantity is number && saleData.quantity > 0
          && saleData.pricePerUnit is number && saleData.pricePerUnit > 0
          && saleData.customer is string && saleData.customer.size() > 0
          && saleData.saleDate is timestamp
          && saleData.total is number && saleData.total > 0;
    }

    function isValidExpenditure(expenditureData) {
      return expenditureData.category is string && expenditureData.category.size() > 0
          && expenditureData.quantity is number && expenditureData.quantity > 0
          && expenditureData.unitPrice is number && expenditureData.unitPrice > 0
          && expenditureData.amount is number && expenditureData.amount > 0
          && expenditureData.expenditureDate is timestamp
          && (expenditureData.description == null || expenditureData.description is string);
    }

    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId) && isExistingDocument();
      allow delete: if isOwner(userId) && isExistingDocument();

      match /flocks/{flockId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId) && isValidFlock(request.resource.data);
        allow update: if isOwner(userId) && isExistingDocument() && isValidFlock(request.resource.data);
        allow delete: if isOwner(userId) && isExistingDocument();
      }
      
      match /sales/{saleId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId) && isValidSale(request.resource.data);
        allow update: if isOwner(userId) && isExistingDocument() && isValidSale(request.resource.data);
        allow delete: if isOwner(userId) && isExistingDocument();
      }

      match /expenditures/{expenditureId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId) && isValidExpenditure(request.resource.data);
        allow update: if isOwner(userId) && isExistingDocument() && isValidExpenditure(request.resource.data);
        allow delete: if isOwner(userId) && isExistingDocument();
      }
    }
  }
}
