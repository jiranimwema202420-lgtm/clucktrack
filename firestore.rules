/**
 * This ruleset enforces a strict user-ownership security model for the CluckHub application.
 *
 * Core Philosophy:
 * The security model is centered around the principle that users own and control their own data.
 * All application data is private to the user who created it, and no data is publicly accessible.
 * This ensures strong data isolation and privacy for each user of the system.
 *
 * Data Structure:
 * All data is organized hierarchically under the `/users/{userId}` path. This structure naturally
 * segments data by owner, allowing for clear, efficient, and secure path-based authorization rules.
 * For example, a user's flocks are stored at `/users/{userId}/flocks/{flockId}`.
 *
 * Key Security Decisions:
 * - Strict Ownership: All read and write operations are restricted to the authenticated user
 *   whose UID matches the `{userId}` in the document path.
 * - No Public Access: There are no publicly readable collections. A user must be signed in
 *   and be the designated owner to access any document.
 * - User Listing Disabled: The rules explicitly prevent any client from listing the documents
 *   in the root `/users` collection, protecting user privacy.
 * - Self-Creation of User Profile: A user can create their own user profile document, but only
 *   if the document ID matches their authentication UID, ensuring data integrity.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to improve readability and maintainability of the rules.
    function isSignedIn() {
      return request.auth != null;
    }

    // Checks if the requesting user is the owner of the document based on the path.
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Checks if a document exists before an update or delete operation.
    function isExistingDocument() {
      return resource != null;
    }

    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId) && isExistingDocument();
      allow delete: if isOwner(userId) && isExistingDocument();

      match /flocks/{flockId} {
        allow read, write: if isOwner(userId);
      }
      
      match /sales/{saleId} {
        allow read, write: if isOwner(userId);
      }

      match /expenditures/{expenditureId} {
        allow read, write: if isOwner(userId);
      }
    }
  }
}
